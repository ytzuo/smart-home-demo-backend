# 智能家居与汽车数据分析报告功能实现操作手册

## 一、功能概述

本文档详细说明如何在现有系统中添加**家居能耗分析**和**车辆健康报告**功能。
 数据通过 DDS 主题传输，并在前端模拟器（MobileAppSimulator）中展示。
 所有修改基于现有架构扩展，不影响原有报警、控制逻辑。

------

## 二、前置条件

- **开发环境**：JDK 8+、Maven、DDS开发环境（已配置 ZRDDS_JAVA 库）
- **代码库文件**：
  - 智能家居后端：`HomeSimulatorAlert.java`
  - 智能汽车后端：`CarSimulator.java`
  - 前端模拟器：`MobileAppSimulator.java`
  - DDS 类型定义目录：`src/main/java/IDL/`

------

## 三、后端开发：新增数据模型与发布逻辑

### 3.1 定义 DDS 数据类型（IDL 文件）

文件路径：`src/main/java/IDL/SmartDemo03.idl`

```
module SmartDemo03 {
    typedef sequence<octet> Blob;
    
    struct Presence {
        boolean inRange;
        string deviceId;
        string deviceType;
        string timeStamp;
    };

    struct VehicleStatus {
        boolean engineOn;
        boolean doorsLocked;
        boolean acOn;
        float fuelPercent;
        string location;
        string timeStamp;
    };

    struct HomeStatus {
        sequence<string> deviceIds;
        sequence<string> deviceTypes;
        sequence<string> deviceStatus; //采用JSON格式, 后端将每个家具的状态分别组成JSON格式, 前端按JSON格式进行解析, 保证可扩展性
        string timeStamp;
    };

    struct Alert {
        string deviceId;
        string deviceType;
        long alert_id;
        string level; //INFO, WARN, ALERT
        string description;
        string timeStamp;
    };

    struct AlertMedia { //报警时传输图像, 暂未启用
        string deviceId;
        string deviceType;
        long alert_id;
        long media_type;
        long total_size;
        long chunk_seq;
        long chunk_size;
        Blob chunk;
    };

    struct Command {
        string deviceId;
        string deviceType;
        string action; //控制命令类型
        float value; //控制命令值
        string timeStamp;
    };
    
    /**
     * 家居能耗报告：用于传输设备能耗统计数据
     */
    struct EnergyReport {
        string deviceId;          // 设备ID（如"light1"、"ac1"）
        string deviceType;        // 设备类型（如"light"、"ac"）
        float currentPower;       // 当前功率（单位：W）
        float dailyConsumption;   // 当日能耗（单位：kWh）
        float weeklyConsumption;  // 本周能耗（单位：kWh）
        string timeStamp;         // 数据采集时间戳（格式：yyyy-MM-dd HH:mm:ss）
    };

    /**
     * 车辆健康报告：用于传输车辆部件状态及维护信息
     */
    struct VehicleHealthReport {
        string vehicleId;                 // 车辆唯一ID（如"car_001"）
        sequence<string> componentTypes;  // 部件类型列表（如"engine"、"tire"、"brake"）
        sequence<string> componentStatuses; // 部件状态列表（"normal"/"warning"/"error"）
        sequence<float> metrics;          // 部件指标列表（如温度、胎压、健康度等数值）
        string nextMaintenance;           // 下次保养建议日期（格式：yyyy-MM-dd）
        string timeStamp;                 // 报告生成时间戳（格式：yyyy-MM-dd HH:mm:ss）
    };
};
```

------

### 3.2 智能家居后端：添加能耗数据发布

#### 3.2.1 创建能耗发布器（EnergyReportPublisher.java）

文件路径：
 `C:/Users/30103/Desktop/summer school/smart-home-demo-backend/HomeSimulator/src/main/java/HomeSimulator/EnergyReportPublisher.java`

主要职责：

- 定时采集设备能耗数据
- 封装为 `EnergyReport`
- 通过 DDS 主题发布

（实现方式参考 `VehicleHealthPublisher`，保持一致的架构）

#### 3.2.2 修改 HomeSimulatorAlert.java 集成发布器

文件路径：
 `C:/Users/30103/Desktop/summer school/smart-home-demo-backend/HomeSimulator/src/main/java/HomeSimulator/HomeSimulatorAlert.java`

修改点：

- **新增成员变量**：`private EnergyReportPublisher energyReportPublisher;`
- **构造函数中初始化发布器**
- **在 start() 方法中启动能耗定时任务**

------

### 3.3 智能汽车后端：添加车辆健康报告发布

#### 3.3.1 创建车辆健康发布器（VehicleHealthPublisher.java）

文件路径：
 `C:/Users/30103/Desktop/summer school/smart-home-demo-backend/CarSimulator/src/main/java/VehicleHealthPublisher.java`

#### 3.3.2 修改 CarSimulator.java 集成发布器

文件路径：
 `C:/Users/30103/Desktop/summer school/smart-home-demo-backend/CarSimulator/src/main/java/CarSimulator.java`

修改点：

- **新增成员变量**：`private VehicleHealthPublisher vehicleHealthPublisher;`
- **构造函数中初始化发布器**
- **在 start() 方法中启动车辆健康数据采集任务**

------

## 四、前端开发：数据订阅与UI展示

### 4.1 前端模拟器（MobileAppSimulator）修改

文件路径：
 `C:/Users/30103/Desktop/summer school/smart-home-demo-backend/AppTest/src/main/java/AppSimulator/MobileAppSimulator.java`

#### 4.1.1 订阅新 DDS 主题

- 注册 `EnergyReport` 和 `VehicleHealthReport` 类型
- 创建订阅器并缓存最新数据

#### 4.1.2 添加 UI 菜单与报告展示

- **家居控制菜单**：新增“d. 查看能耗报告”选项
- **车辆控制菜单**：新增“e. 查看健康报告”选项

------

## 五、测试与验证

### 5.1 后端数据发布验证

- 启动家居后端，日志应输出：

  ```
  [EnergyReportPublisher] 发布能耗报告: 设备=ac1, 当日能耗=3.60kWh
  ```

- 启动车辆后端，日志应输出：

  ```
  [VehicleHealthPublisher] 发布车辆健康报告: car_001
  ```

### 5.2 前端数据展示验证

进入前端模拟器：

- 菜单 → “家居控制” → “d. 查看能耗报告”

  ```
  🏠 家居能耗报告 (2024-05-20 15:30:00)
  设备ID: ac1
  当前功率: 1500.0W
  当日能耗: 3.60kWh
  本周能耗: 25.20kWh
  ```

- 菜单 → “车辆控制” → “e. 查看健康报告”

  - 展示各部件状态和指标

------

## 六、常见问题与解决

| 问题现象           | 可能原因           | 解决方法                                                     |
| ------------------ | ------------------ | ------------------------------------------------------------ |
| 前端收不到报告数据 | DDS 主题名称不匹配 | 检查后端发布与前端订阅的主题名称是否一致（如“EnergyReport”） |
| 报告数据字段为空   | IDL 类型未注册     | 确保 `EnergyReportTypeSupport` 和 `VehicleHealthReportTypeSupport` 已注册到参与者 |
| 定时任务未执行     | 线程池未启动       | 确认 `scheduleAtFixedRate` 已调用                            |

------

## 七、总结

通过本文档操作，系统将在 **不修改原有报警/控制逻辑** 的前提下，
 新增 **家居能耗分析** 和 **车辆健康报告** 功能。
 后端分别由 `EnergyReportPublisher` 和 `VehicleHealthPublisher` 负责数据发布，
 前端通过菜单查看报告，实现类似主流 App 的数据分析展示效果。