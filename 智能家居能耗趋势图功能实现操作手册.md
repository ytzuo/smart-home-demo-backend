# 智能家居能耗趋势图功能实现操作手册

## 一、功能概述

本功能用于在现有系统中扩展 **能耗趋势图**：

- 前端用户可在菜单中选择“请求能耗趋势图”；
- 前端向后端发送请求命令；
- 后端从缓存中提取最近的能耗历史数据，生成折线图（PNG 图片）；
- 图片通过 DDS 消息传输到前端；
- 前端接收图片文件，提示用户保存或查看。

此功能在原有 **能耗报告（EnergyReport）** 基础上扩展，不影响已有报警、控制逻辑。

------

## 二、前置条件

- 已配置开发环境（JDK、Maven、DDS、ZRDDS_JAVA 库）；
- 系统已具备 **能耗数据采集与发布功能（EnergyReportPublisher）**；
- 后端已能缓存历史能耗数据；
- 前端与后端之间的 DDS 通道正常。

------

## 三、数据交互设计

### 3.1 前端请求命令

- 请求通过 **Command** 消息发送；
- `action` 字段定义为 `"getEnergyTrend"`；
- `deviceId` 指定目标设备，例如 `"ac1"`；
- 后端识别该命令后，生成并返回趋势图。

### 3.2 IDL新增数据结构 `ReportMedia`

```java
struct ReportMedia { //用于趋势图/健康报告图表等可视化结果传输
    string reportId;        // 报告唯一ID（如"energy_ac1_20250912"）
    string reportType;      // 报告类型（如"EnergyTrend", "VehicleHealth"）
    string deviceId;        // 关联设备ID
    long total_size;        // 图片总大小（字节数）
    long chunk_seq;         // 当前分片序号（从0开始）
    long chunk_size;        // 当前分片大小
    Blob chunk;             // 图片分片内容
    string timeStamp;       // 报告生成时间戳
};
```

### 3.3 流程概述

1. **前端发送请求**：Command(action=getEnergyTrend)。
2. **后端生成折线图**：基于缓存数据生成 PNG 图片。
3. **后端发送图片**：传输逻辑。
4. **前端接收**：接收逻辑。

------

## 四、后端实现步骤

1. **维护历史数据缓存**
   - 后端在发布 `EnergyReport` 的同时，将数据存入缓存（例如最多保留最近100条）。
   - 缓存以 `deviceId` 为索引，便于按设备生成趋势图。
2. **监听 Command 请求**
   - 后端订阅 `Command` 类型消息；
   - 当检测到 `action=getEnergyTrend` 时，触发趋势图生成逻辑。
3. **生成趋势图**
   - 从缓存中读取目标设备的历史能耗数据；
   - 生成折线图（PNG 图片），图表包含：
     - 横轴：时间戳；
     - 纵轴：功率（W）；
     - 标题：设备ID及趋势说明。
4. **图片传输**

------

## 五、前端实现步骤

1. **新增菜单选项**

   - 在“家居控制”菜单中增加“请求能耗趋势图”；
   - 用户选择后，前端生成 `Command` 消息并发布。

2. **发送请求命令**

   - 填写 `deviceId`（如 `"ac1"`）、`action="getEnergyTrend"`；
   - 发布到 DDS 主题，等待后端返回图片数据。

3. **接收 ReportMedia 图片**

4. **保存并提示用户**

   - 将 PNG 文件保存到本地目录；

   - 在控制台输出提示，例如：

     ```
     [MobileAppSimulator] 能耗趋势图已保存: ac1_EnergyTrend.png
     ```

------

## 六、测试与验证

1. **启动后端**：确认能耗数据缓存正常累积。

   ```
   [EnergyReportPublisher] 发布能耗报告: 设备=ac1, 当前功率=1500.0W
   ```

2. **前端请求趋势图**：选择菜单项，发送请求命令。

   ```
   [MobileAppSimulator] 已请求能耗趋势图: ac1
   ```

3. **后端生成并发送**：在日志中输出生成与发送状态。

   ```
   [HomeSimulatorAlert] 已生成能耗趋势图: ac1 (600x400 PNG)
   ```

4. **前端接收并保存**：

   ```
   [MobileAppSimulator] 报告图片已保存: ac1_EnergyTrend.png
   ```

5. **打开文件**：验证图片正确显示，折线图完整无误。

------

## 七、总结

通过本文档操作，系统支持：

- 前端主动请求能耗趋势图；
- 后端基于缓存数据生成图表（PNG）；
- 图表通过 DDS 传输；
- 前端保存图片文件。

最终实现了 **历史能耗数据的可视化**，提升了系统的分析与展示能力。